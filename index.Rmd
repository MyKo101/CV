---
title: "Michael Barrowman"
always_allow_html: true
output:
  html_document:
    includes:
      in_header: "header.html" 
    css: style.css
#  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(kableExtra)
library(lubridate)
library(magrittr)
library(glue)
```

```{r functions, include=F}

## Functions related to which format we are using
{
  get_format <- function(x=NULL)
  {
    if(knitr:::is_latex_output())
      cFormat <- "latex" else 
        cFormat <- "html"
      
    if(!is.null(x))
    {
      return(cFormat == x)
    } else {
      return(cFormat)
    }
  }
  
  create_choice <- function(...)
  {
    res <- list(...)
    if(is.null(names(res))) names(res) <- c("latex","html")
    class(res) <- "choiceobject"
    nm <- names(res)
    sep <- case_when(nm == "html" ~ "<br>",
                     nm == "latex" ~ "\\newline ",
                     T ~ "")
    res <- lapply(1:length(res),
                  function(i) paste0(res[[i]],collapse=sep[i]))
    names(res) <- nm
    class(res) <- "choiceobject"
    return(res)
  }
  
  get_choice <- function(choiceobj)
  {
    if(class(choiceobj) == "choiceobject")
    {
      return(choiceobj[[get_format()]])
    } else
      return(choiceobj)
  }
}

glue_template <- function(.tbl,variable_name,template)
{
  glue_string <- get_choice(template)
  
  .tbl %>%
    mutate(!!enquo(variable_name) := 
             paste0(str_glue_data(.tbl,glue_string)))
    
}

make_authors <- function(.tbl,authors_var)
{
  old_authors <- c("First Author","Second Author", "Third Author","More Authors")
  if(any(!old_authors %in% names(.tbl)))
    stop("Missing Author variable")
  
  gl1 <- "{`First Author`}"
  gl2 <- "{`First Author`} & {`Second Author`}"
  gl3 <- "{`First Author`}, {`Second Author`} & {`Third Author`}"
  gl4 <- "{`First Author`}, {`Second Author`}, {`Third Author`} & {`More Authors`}"
  gl5 <- "{`First Author`}, {`Second Author`}, {`Third Author`} et al"
  
  
  .tbl %>%
    mutate(.aut_glue = case_when(`More Authors` == "et al" ~ gl5,
                                 `More Authors` != "" ~ gl4,
                                 `Third Author` != "" ~ gl3,
                                 `Second Author` != "" ~ gl2,
                                 T ~ gl1)) %>%
    split(1:nrow(.)) %>%
    map_dfr(~mutate(.,.autemp = paste0(glue(.aut_glue)))) %>%
    mutate(.autemp = gsub("MA Barrowman","**MA Barrowman**",.autemp,fixed=T)) %>%
    mutate(!!enquo(authors_var) := .autemp) %>%
    select(-.aut_glue,-.autemp)
  
}

kable_W <- function(.tbl,...)
{
  .tbl %>%
    if_fun(get_format("latex"),
           function(x) x %>%
             mutate_if(is.character,~gsub("&","\\&",.,fixed=T))%>%
             rename_all(~gsub("&","\\&",.,fixed=T))) %>%
    kable(...,
          format=get_format(),
          escape=F,
          booktabs=T,col.names=rep("",ncol(.tbl)))
}
    
if_fun <- function(.x,.predicate,.fun,.elsefun=NULL) 
{
  if(.predicate) .fun(.x) else 
    if(!is.null(.elsefun))
      .elsefun(.x) else
        .x
}
  


```

::::{style="display: grid; grid-template-columns: 1fr 2fr; grid-column-gap: 20px;"}

:::{}

```{r profile,echo=F,out.width="95%"}
knitr::include_graphics("img/ProfileHex.png")
```



```{r contact, echo=F}

contact_template <- create_choice(
  latex = "{medium}: {contact}",
  html = "<img src=\"{favicon}\" width=\"20px\" >: <a href =\"{link}\">{contact}</a>"
)

read_csv("data/Contact.csv",col_types=cols()) %>%
  mutate(favicon = paste0("img/logos/",medium,"-logo.png"))%>%
  glue_template(ss,contact_template) %>%
  select(ss) %>%
  kable_W

```



:::

:::{}

# {.tabset}

## Bio

### About Me

I am currently studying towards a PhD in Medicine with a focus on statistics from both an applied and methodological perspective, whilst working as a Maths and Stats Tutor and developing my skills as a keen data scientist, particularly in R. I have experience in the public and private sector, dealing primarily with medical and education data. 

### Skills

```{r skills, echo=F}
skills_hl <- c("R","RMarkdown","LaTeX","SPSS","NVivo","Git","GitHub","HTML/CSS","Python","SAS","Stata","SQL","Photoshop") %>%
  paste0("<span class=skilllogo><img src=\"img/logos/",gsub("/","-",.),"-logo.png\" height=20px/> ",.,"</span>") %>%
  paste0(collapse="&emsp13;&mdash;&emsp13;")
```

`r skills_hl`


This Online CV was coded using RMarkdown [[Source](https://github.com/MyKo101/CV)]


## Experience

&nbsp;

I have worked in a variety of roles in both the public and private sector, covering two primary fields: Education and Data Analysis. Several of my roles have incorporated both of these facets.

&nbsp;

```{r, echo=F}
Exp_tbl <- read_csv("data/Experience.csv",col_types = cols()) %>%
  mutate(Start = dmy(paste0("01 ",Start),quiet=T),
         End = dmy(paste0("01",End),quiet=T)) %>%
  arrange(!is.na(End),desc(Start)) %>%
  mutate(Employer = fct_inorder(Employer)) %>%
  arrange(Employer,!is.na(End),desc(End)) %>%
  mutate(Start = format(Start,"%b '%y"),
         End = format(End,"%b '%y"),
         End = replace_na(End,"Present"))

Exp_Template <- create_choice(
  latex=c("**{`Job Title`}**, {Start} - {End}",
          "{Description}"),
  html="<div class=\"grow\">**{`Job Title`}**, {Start} - {End}<p>{Description}</p></div>"
)


grp_index <- auto_index(as.character(Exp_tbl$Employer))
Exp_tbl %<>% select(-Employer)

Exp_tbl %>%
  glue_template(ss,Exp_Template) %>%
  select(ss) %>%
  kable_W %>%
  kable_styling(bootstrap_options = "basic",
                latex_options=) %>%
  pack_rows(index=grp_index)
```

## Packages

&nbsp;

```{r packages,echo=F, asis=T}

Pack_tbl <- read_csv("data/Packages.csv",col_types=cols())

Package_img <- create_choice(
  latex=c("NULL"),
  html=c("<center><a href=\"{link}\"><img src=\"{logo}\" width=\"95\\%\"/></a></center>")
)

Package_text <- create_choice(
  latex=c("**{Name}**","{Description}"),
  html=c("**{Name}**","{Description}")
)

Pack_out <- Pack_tbl %>%
  glue_template(img,Package_img) %>%
  glue_template(text,Package_text) %>%
  select(img,text) %>%
  mutate(align = row_number() %% 2 == 1,
         left_col = if_else(align,img,text),
         right_col = if_else(align,text,img)) %>%
  select(align,left_col,right_col) %>%
  split(1:nrow(.)) %>%
  map_chr(function(x)
    {
      align <- x$align
      x %>%
        select(left_col,right_col) %>%
        kable_W %>%
        column_spec(column=1+1*!align,width="20%") %>%
        paste0
    }) %>%
  paste0(collapse="\n")
```
`r Pack_out`

## Publications
&nbsp;


```{r publications, echo=F}


Pub_Template <- create_choice(
  latex="{authors}, *{Title}*, {Journal} ({Year}) doi:{doi}",
  html="<p>{authors}, *{Title}*, {Journal} ({Year}) doi:<a href=\"https://doi.org/{doi}\">{doi}</a></p>"
)

read_csv("data/Publications.csv",col_types=cols()) %>%
  make_authors(authors) %>%
  glue_template(ss,Pub_Template) %>%
  select(ss)%>%
  if_fun(get_format("html"),
         function(x) kable_W(x,padding=0),
         function(x) kable_W(x))

```

:::
::::